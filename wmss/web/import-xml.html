<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>

		<form class="md-form" id="formImport" class="md-form" method="post" enctype="multipart/form-data">
				<input id="input_files" type="file" name="file" multiple/>
		</form>



<br><br>
<form>
	<div class="form-row">
	<div class="form-group col-md-3">
	  <label for="inputURI">URI</label>
	  <input type="url" class="form-control" id="inpuURI" placeholder="URI">
	</div>
	<div class="form-group col-md-8">
	  <label for="inputTitle">Title</label>
	  <input type="text" class="form-control" id="inputTitle" placeholder="Title">
	</div>
	<div class="form-group col-md-1">
	  <label for="inputTitle">Date Issued</label>
	  <input type="text" class="form-control" id="inputIssued" placeholder="Issued">
	</div>
	</div>

	<div class="form-row">
		<div class="form-group col-md-4">
	  <label for="inputThumbnail">Thumbnail</label>
	  <input type="text" class="form-control" id="inputThumbnail" placeholder="Thumbnail">
	</div>
	<div class="form-group col-md-4">
	  	<label for="collection-url">Collection URL</label>
	  	<input class="form-control" list="collection-url-list" id="collection-url">
	  	<datalist id="collection-url-list"></datalist>

	</div>
	<div class="form-group col-md-4">
	  <label for="collection-description">Collection Description</label>
	  	<input class="form-control" list="collection-description-list" id="collection-description">
	  	<datalist id="collection-description-list"></datalist>
	</div>
	</div>
</form>
<table class="table">
	<tr>
		<th style="width: 50%;text-align: center">Persons</th>
		<th style="width: 50%;text-align: center">Resources</th>
	</tr>
	<tr>
		<td style="width: 50%">
			<table id="table-persons" class="table table-borderless">
				<tr>
					<td style="width: 35%; padding: 4px;">
					<input id="persons-uri" class="form-control" list="persons-uri-list">
					  <datalist id="persons-uri-list"></datalist>
					</td>
					<td style="width: 35%; padding: 4px;">
					  <input class="form-control" list="persons-name-list" id="persons-name">
					  <datalist id="persons-name-list"></datalist>						  
					</td>
					<td style="width: 25%; padding: 4px;">
						<select id="person-role" class="form-control"id="select-format">
							<option value="Composer" selected> Composer</option>
							<option value="Encoder"> Encoder</option>
							<option value="Arranger"> Arranger</option>
							<option value="Librettist"> Librettist</option>
							<option value="Lyricist"> Lyricist</option>
							<option value="Performer"> Performer</option>
						</select>
					</td>
					<td style="padding: 4px;"><button type="submit" class="btn btn-primary" onclick="addPerson();"><i class="fas fa-plus"></i></button></td>
				</tr>				
			</table>
		</td>
		<td style="width: 50%">
			<table id="table-resources" class="table table-borderless">
				<tr>
					<td style="width: 35%; padding: 4px; padding-left: 0px"><input id="resource-url" class="form-control" type="text" name="" placeholder="URL"/></td>
					<td style="width: 35%; padding: 4px; padding-left: 0px"><input id="resource-description" class="form-control" type="text" name="" placeholder="Description"/></td>
					<td style="width: 25%; padding: 4px;">
						<select id="resource-mime-type" class="form-control"id="select-format">
							<option value="application/pdf"> PDF</option>
							<option value="text/html" selected> Web Link</option>
							<option value="application/xml"> XML</option>
							<option value="application/json"> JSON Format</option>
							<option value="audio/mpeg"> MP3 Audio</option>
							<option value="audio/ogg"> OGG Audio</option>
							<option value="audio/midi"> MIDI Audio</option>
							<option value="video/mpeg"> MPEG Video</option>
						</select>
					</td>
					<td style="padding: 4px;"><button type="submit" class="btn btn-primary" onclick="addResource();"><i class="fas fa-plus"></i></button></td>
				</tr>				
			</table>
		</td>
	</tr>

</table>

<button id="btn-load" class="btn btn-primary" data-title="Import" onclick="importMusicXML();"><i class="fa fa-upload" aria-hidden="true"></i>    Import</button>

<script type="text/javascript">

	loadFilters();

	function importMusicXML(){




			var metadataStr =  "<?xml version='1.0' encoding='UTF-8'?>"+
					"<score>"+
					"	<scoreIdentifier>http://dbpedia.org/resource/Cello_Concerto_(Elgar)</scoreIdentifier>"+
					"	<title>Cellokonzert e-Moll op. 85</title>"+
					"	<thumbnail>https://www.rcm.ac.uk/media/Elgar%20Cello%20Concerto%20maunscript%206x4.jpg</thumbnail>"+
					"	<issued>1919</issued>"+
					"	<collections>"+
					"		<collection>"+
					"			<collectionName>Great Composers</collectionName>"+
					"			<collectionURL>https://wwu.greatcomposers.de</collectionURL>"+
					"		</collection>"+
					"	</collections>"+
					"	<persons>"+
					"		<person>"+
					"			<personIdentifier>http://dbpedia.org/resource/Edward_Elgar</personIdentifier>"+
					"			<personName>Sir Edward William Elgar</personName>"+
					"			<personRole>Composer</personRole>"+
					"		</person>"+
					"		<person>"+
					"			<personIdentifier>http://jimjones.de</personIdentifier>"+
					"			<personName>Jim Jones</personName>"+
					"			<personRole>Encoder</personRole>"+
					"		</person>"+
					"	</persons>"+
					"	<resources>"+
					"		<resource>"+
					"			<resourceURL>https://musescore.com/score/152011/download/pdf</resourceURL>"+
					"			<resourceDescription>Print</resourceDescription>"+
					"			<resourceType>application/pdf</resourceType>"+
					"		</resource>"+
					"		<resource>"+
					"			<resourceURL>https://en.wikipedia.org/wiki/Cello_Concerto_(Elgar)</resourceURL>"+
					"			<resourceDescription>Wikipedia Article</resourceDescription>"+
					"			<resourceType>text/html</resourceType>"+
					"		</resource>"+
					"	</resources>"+
					"</score>";

					metadataStr = metadataStr.replace("\t","");
					metadataStr = metadataStr.replace("\n","");


		$("#btn-load").html('<i class="fas fa-spinner fa-spin"></i> Importing ..');
		

			var formData = new FormData();
			formData.append('source', current_source);
			formData.append('file', $('#input_files')[0].files[0]);
			formData.append('commitsize', 10000);
			formData.append('format', 'musicxml');
			formData.append('metadata', metadataStr);

	        console.log(formData);
					
			$("#btn-load").html('<i class="fas fa-spinner fa-spin"></i> Importing ..');	
        
			$.post({
			   url: base_url + '/import',  
			   type: 'POST',
			   data: formData,
			   cache: false,
			   contentType: false,
			   processData: false,
			   success: function(data) {
			    	console.log(data);
			    }
			}, 'json');
		
		
	}
	


	
	function addPerson(){

		if(document.getElementById($('#persons-uri').val().trim()) == null) {
		
			if(isURLValid($('#persons-uri').val().trim()) && $('#persons-name').val() != ''){

				$('#table-persons tr:last').after('<tr id="'+$('#persons-uri').val()+'" style="text-align: center" class="person-row">'+
												  '	   <td style="width: 35%; padding: 8px;">'+$('#persons-uri').val()+'</td>'+
												  '	   <td style="width: 35%; padding: 8px;">'+$('#persons-name').val()+'</td>'+
												  '	   <td style="width: 25%; padding: 8px;">'+$('#person-role').val()+'</td>'+
												  '	   <td style="padding: 4px;"><button type="submit" class="btn btn-danger" onclick="deleteRow(\''+$('#persons-uri').val().trim()+'\');"><i class="fas fa-remove"></i></button></td>'+										  
												  '</tr>');

				$('#persons-name').val('');
				$('#persons-uri').val('');

			} else {
				$.alert({
					icon: 'fa fa-times',
					type: 'red',
				    title: 'Error',
				    content: 'Person data invalid.',
				});

			}
		} else {

			$.alert({
				icon: 'fa fa-times',
				type: 'red',
			    title: 'Error',
			    content: 'You have already inserted a person with the given identifier.<br><br>'+ $('#persons-uri').val(),
			});
		}
	}


	function deleteRow(id){

		var row = document.getElementById(id);
		row.parentNode.removeChild(row);

	}

	function addResource(){

		if(document.getElementById($('#resource-url').val().trim()) == null) {
		
			if(isURLValid($('#resource-url').val().trim()) && $('#resource-description').val() != ''){

				$('#table-resources tr:last').after('<tr id="'+$('#resource-url').val().trim()+'" style="text-align: center" class="resource-row">'+
												  '	   <td style="width: 35%; padding: 8px;">'+$('#resource-url').val()+'</td>'+
												  '	   <td style="width: 35%; padding: 8px;">'+$('#resource-description').val()+'</td>'+
												  '	   <td style="width: 25%; padding: 8px;">'+$('#resource-mime-type').val()+'</td>'+
												  '	   <td style="padding: 4px;"><button type="submit" class="btn btn-danger" onclick="deleteRow(\''+$('#resource-url').val().trim()+'\');"><i class="fas fa-remove"></i></button></td>'+										  
												  '</tr>');

				$('#resource-url').val('');
				$('#resource-description').val('');

			} else {
				$.alert({
					icon: 'fa fa-times',
					type: 'red',
				    title: 'Error',
				    content: 'Resource data invalid.',
				});

			}

		} else {

			$.alert({
				icon: 'fa fa-times',
				type: 'red',
			    title: 'Error',
			    content: 'You have already inserted a resource with the given identifier.<br><br>'+ $('#resource-url').val(),
			});

		}
	}


	function loadFilters(){

		$.getJSON(base_url+"?request=DescribeService", function(data){

			sources = data["datasources"];
			
	        for (i = 0; i < sources.length; i++) { 

	        	var src = sources[i];

	        	if(src["id"]==current_source){

		        	var collections = src["collections"];
		        	for (j = 0; j < collections.length; j++) { 
		        		var col = collections[j];
		        		var opt_collection_url = document.createElement("option");
		        		opt_collection_url.value = col["id"];
		        		opt_collection_url.label = col["description"];		        	 	
		        	 	$('#collection-url-list').append(opt_collection_url); 
		        	 	var opt_collection_description = document.createElement("option");
		        		opt_collection_description.value = col["description"];
		        		opt_collection_description.label = col["id"];		        	 	
		        	 	$('#collection-description-list').append(opt_collection_description); 

		        	}

		        	var persons = src["persons"];
		        	for (j = 0; j < persons.length; j++) { 
		        		var col = persons[j];

						var opt_person_url = document.createElement("option");
		        		opt_person_url.value = col["url"];
		        		opt_person_url.label = col["name"];		        	 			        	 	
		        	 	$('#persons-uri-list').append(opt_person_url); 
						var opt_person_name = document.createElement("option");
		        		opt_person_name.value = col["name"];
		        		opt_person_name.label = col["url"];		        	 	
		        	 	$('#persons-name-list').append(opt_person_name); 
		        	}
		        	

	        	}

	        }

		});
	}


	$("#collection-url").on('input', function () {		
		if($("#collection-description").val() == ''){
			$("#collection-description").val($("#collection-url-list option[value='" + $("#collection-url").val() + "']").attr("label"));	
		}		
	});

	$("#collection-description").on('input', function () {		
		if($("#collection-url").val() == ''){
			$("#collection-url").val($("#collection-description-list option[value='" + $("#collection-description").val() + "']").attr("label"));
		}
	});

	$("#persons-uri").on('input', function () {		
		if($("#persons-name").val() == ''){
			$("#persons-name").val($("#persons-uri-list option[value='" + $("#persons-uri").val() + "']").attr("label"));
		}
	});

	$("#persons-name").on('input', function () {		
		if($("#persons-uri").val() == ''){
			$("#persons-uri").val($("#persons-name-list option[value='" + $("#persons-name").val() + "']").attr("label"));
		}
	});


	function isURLValid(str) {
  var pattern = new RegExp('^(https?:\\/\\/)?'+ 
  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ 
  '((\\d{1,3}\\.){3}\\d{1,3}))'+ 
  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+
  '(\\?[;&a-z\\d%_.~+=-]*)?'+ 
  '(\\#[-a-z\\d_]*)?$','i'); 
  return pattern.test(str);
}

</script>
</body>
</html>