<!DOCTYPE html>
<html lang="en">
	<head>	
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">-->
		<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">-->

		<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>-->
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>-->
		
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
			
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

	</head>

	<body>			

		<div class="table-responsive">
			<table class="table table-borderless">
				<thead>
					<th width='2%'></th>
					<th></th>
				</thead>
				<tbody>
					<tr>
						<td style="text-align: center;"><input id='check-all' type='checkbox'/></td>
						<td><button id="btn-delete-all" class="btn btn-danger" data-title="Delete" data-toggle="modal" data-target="#delete"><i class="fa fa-trash" aria-hidden="true"></i>    Delete</button></td>
					</tr>
				</tbody>
			</table>

			<table id="table-resultset" class="table table-striped" >
				<thead></thead>
				<tbody></tbody>
			</table>
		</div>
		
		<script type="text/javascript">


			$("#btn-delete-all").hide();

			$(document).on('click', ".header", function() {   				
			    $header = $(this);
			    $content = $header.next();
			    $content.slideToggle(200, function () {			        
			    });
			});
	
		
			$('#check-all').change(function () {

				if($('#check-all').is(':checked')) {
				    $("#btn-delete-all").show();
				    $('.check-score').prop('checked', true);
				} else {
				    $("#btn-delete-all").hide();
				    $('.check-score').prop('checked', false);
				}

			});


			$("#btn-delete-all").click(function(){

				deleteAll();			

			});


			function showDeleteAllButton(){

				var chk = document.getElementsByClassName("check-score");
				var checked_items = 0;

				for (i = 0; i < chk.length; i++) { 

					if(chk[i].checked){
						checked_items++;
					}

				}

				if(checked_items>0){
					$("#btn-delete-all").show();
				} else {
					$("#btn-delete-all").hide();
				}

			}

			var url = "http://"+window.location.host+"/"+window.location.pathname.split('/')[1];

			$( document ).ready(function() {

				$('#table-resultset').attr('border', '1');
	    		$("#table-resultset tr").remove();
	    		$("#table-resultset thead").empty();
	    		$("#table-resultset thead").append("<th width='1%'></th><th width='5%'></th><th>Music Score</th><th>Related Persons</th><th>Movements</th><th></th>");

				$.getJSON(url+"?source="+current_source+"&request=ListScores&pageSize=50", function(data){

					var sources = data["datasources"];

					for (i = 0; i < sources.length; i++) { 
        	 			
        	 			var src = sources[i];
        	 			
        	 			if(src["identifier"]==current_source){

        	 				var scores = src["scores"];

							for (j = 0; j < scores.length; j++) { 

								var sc = scores[j];


								var formats = sc["formats"];
								var formats_string = "";

								for (k = 0; k < formats.length; k++) { 

									var fr = formats[k];
									var badge_class = "";
									if (fr["formatId"]=="musicxml"){
										badge_class="badge badge-pill badge-info";
									} else if (fr["formatId"]=="mei"){
										badge_class="badge badge-pill badge-secondary";
									} else {
										badge_class="badge badge-pill badge-dark";
									}
									formats_string = formats_string + '<a style="font-size:18px" href="javascript:getScore(\''+j+'\',\''+fr["formatId"]+'\')"><span style="display: block;" class="'+badge_class+'"><i class="fa fa-download"/> '+fr["formatDescription"]+'</span></a>';

								}							

								var persons = sc["persons"];
								var persons_string = "";

								for (k = 0; k < persons.length; k++) { 

        	 						var per = persons[k];
        	 						var badge_class;

        	 						if(per["role"]=='Composer'){
        	 							badge_class = 'badge badge-pill badge-info';
        	 						} else {
        	 							badge_class = 'badge badge-pill badge-secondary';
        	 						} 

        	 						persons_string = persons_string +'<p><a href="'+per["url"]+'">' + per["name"] + '</a> <span class="'+badge_class+'">'+per["role"]+'</span></p>';

        	 					}
        	 				        	 					
        	 					var movements = sc["movements"];
					
        	 					$('#table-resultset').append('<tr id="'+j+'" class="row-score">' +
        	 					'<td style="text-align: center;"><input id="check-'+j+'" type="checkbox" class="check-score" onclick="showDeleteAllButton();"/></td>'+
        	 					'<td style="text-align: center;"><img style="max-width: 125px" src="'+ sc["thumbnail"] + '"/></td>' +        	 					
        	 					'<td><form class="col-12">'+
								'	  <div class="form-row">'+
								'	    <label class="col-sm-2 col-form-label" for="identifier">Identifier:</label>'+
								'	    <div id ="score_id_container" class="col-sm-10"><p id="score_id_'+j+'" class="form-control-static">'+sc["scoreIdentifier"] +'</p></div>'+
								'	  </div>'+
								'	  <div class="form-row">'+
								'		<label class="col-sm-2 col-form-label" for="title">Title:</label>'+
								'	    <div class="col-sm-10"><p id="score_title_'+j+'" class="form-control-static">'+sc["title"] +'</p></div>'+
								'	  </div>'+
								'	  <div class="form-row">'+
								'		<label class="col-sm-2 col-form-label" for="issued">Issued:</label>'+
								'	    <div class="col-sm-10"><p class="form-control-static">'+sc["dateIssued"] +'</p></div>'+
								'	  </div>'+
								'	  <div class="form-row">'+
								'		<label class="col-sm-2 col-form-label" for="online-resource">Resource:</label>'+
								'	    <div class="col-sm-10"><p class="form-control-static"><a href="'+ sc["onlineResource"] + '">'+sc["onlineResource"]+'</a></p></div>'+
								'	  </div>'+

								'	  <div class="form-row">'+
								'		<div class="col-sm-100"><p class="form-control-static" style="style: none;">'+ formats_string+'</p></div>'+								
								'	  </div>'+
								'	</form> '+							
								'</td>' + 
	                			'<td>'+ persons_string + '</td>' +	                			
	                			'<td><div id="movements-'+j+'" class="accordion"></div></td>'+
	             				'<td style="text-align: center;"><a href="javascript:deleteScore(\''+j+'\')"><p id="del_'+j+'" data-placement="top" data-toggle="tooltip" title="Delete"><button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete" ><i class="fa fa-trash"/></button></p></a></td>' +
	             				'</tr>');

	             				for (k = 0; k < movements.length; k++) { 

        	 						var mov = movements[k];

        	 						

									$('#movements-'+j).append('<div class="card">'+
															  '  <div class="card-header" id="heading-'+j+k+'">'+
															  '    <h5 class="mb-0">'+
															  '      <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-'+j+k+'" aria-expanded="false" aria-controls="collapse-'+j+k+'">'+
															  '        '+mov["movementName"]+
															  '      </button>'+
															  '    </h5>'+
															  '  </div>'+
															  '  <div id="collapse-'+j+k+'" class="collapse hide" aria-labelledby="heading-'+j+k+'" data-parent="#movements-'+j+'">'+
															  '    <div id="medium-'+j+k+'" class="card-body">'+
															  '    </div>'+
															  '  </div>'+
															  '</div>');        	 						

        	 						var perf_type = mov["performanceMediumList"];

        	 						for (l = 0; l < perf_type.length; l++) { 
									
        	 							var perf = perf_type[l];
        	 							var medium = perf["mediums"];
       	 							
        	 							for (m = 0; m < medium.length; m++) { 

        	 								var med = medium[m];        	 								
        	 								$('#medium-'+j+k).append(med["mediumScoreDescription"]+' ('+med["mediumDescription"]+')<br>');
        	 								
        	 								
        	 							}
        	 						}
        	 					}

        	 				}
        	 			}
        	 		}
				});
			});


			function getScore(row_number,format) {


				$('#get-score-'+row_number).empty();
				$('#get-score-'+row_number).append('<div class="spinner-border text-info"></div>');

				var dataUrl = url+'?source='+$('#ds').val()+'&request=GetScore&identifier='+$('#score_id_'+row_number).text()+'&format='+format;
				var filename = $('#score_title_'+row_number);

			    var link = document.createElement("a");
			    link.download = filename;
			    link.target = "_blank";


			    link.href = dataUrl;
			    document.body.appendChild(link);
			    link.click();

			    document.body.removeChild(link);
			    delete link;

			    $('#get-score-'+row_number).empty();
				$('#get-score-'+row_number).append('<button class="btn btn-info btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
										 '	<i class="fa fa-download"/>'+
										 '</button>');

			}


			function deleteAll(){


				$.confirm({
				    title: 'Multiple Delete: ' + $('#table-resultset tr').filter(':has(:checkbox:checked)').length + ' Scores',
				    content: 'Are you sure you want to delete the selected scores? Think twice: this operation <b>cannot</b> be undone.',
				    buttons: {
				        cancel: function () {
				            
				        },
				        somethingElse: {
				            text: 'Delete',
				            btnClass: 'btn-red',
				            keys: ['enter', 'shift'],
				            action: function(){

								$('#table-resultset tr').filter(':has(:checkbox:checked)').each(function() {

									var row = this;
									$('#del_'+row.id).empty();
									$('#del_'+row.id).append('<div class="spinner-border text-danger"></div>');

									$.getJSON(url+'?source='+current_source+'&request=DeleteScore&identifier='+$('#score_id_'+row.id).text(), function(data){

										if(data["type"]=='DeleteScoresReport'){						
											row.parentNode.removeChild(row);
											$("#btn-delete-all").hide();
											$('.check-score').prop('checked', false);
										} else {
												
											$('#del_'+row.id).append('<button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
																'	<i class="fa fa-trash"/>'+
																'</button>');
											$("#btn-delete-all").show();
											$('.check-score').prop('checked', true);
										}
									});
								});		
				            }
				        }
				    }
				});
			}

			
			function deleteScore(row_number){

				var row = document.getElementById(row_number);

				$.confirm({
				    title: 'Delete Score',
				    content: 'Are you sure you want to delete this music score? This operation <b>cannot</b> be undone!<br><br>' + $('#score_title_'+row_number).text(),
				    buttons: {
				        delete: {
				        	btnClass: 'btn-red',
				        	action: function () {
				
							$('#del_'+row_number).empty();
							$('#del_'+row_number).append('<div class="spinner-border text-danger"></div>');

							$.getJSON(url+'?source='+current_source+'&request=DeleteScore&identifier='+$('#score_id_'+row_number).text(), function(data){

								if(data["type"]=='DeleteScoresReport'){						

									row.parentNode.removeChild(row);
									showDeleteAllButton();
								} else {
									$.alert('Music score could not be deleted.<br>'+
										'<br><b>Code</b>: '+data["code"]+
										'<br><b>Message</b>: '+data["message"]);									
									$('#del_'+row_number).html('<button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
																	'<i class="fa fa-trash"/>'+
																 '</button>');
								}
							});

				        }},

				        cancel: function () {

				        }
				    }
				});
			}

		</script>



	</body>	


</html>
