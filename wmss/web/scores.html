<!DOCTYPE html>
<html lang="en">
	<head>	
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
			
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

	</head>

	<body>			

		<h2>WMSS Score Management</h2>

		Data Source: 
		<select id="ds">
			<option>neo4j_local</option>
		</select> 
		Page size: <input id="page_size" value="15"></input>
		<button id="btn-load">Load</button> <br/><br>


		<div class="table-responsive">

			<table class="table">
				<thead>
					<th width='2%'></th>
					<th></th>
				</thead>
				<tbody>
					<tr>
						<td style="text-align: center;"><input id='check-all' type='checkbox'/></td>
						<td><button id="btn-delete-all" class="btn btn-danger" data-title="Delete" data-toggle="modal" data-target="#delete"><span class="glyphicon glyphicon-trash"></span>    Delete</button></td>
					</tr>
				</tbody>
			</table>

			<table id="table-resultset" class="table table-bordred table-striped">
				<thead></thead>
				<tbody></tbody>
			</table>
		</div>
		
		<script type="text/javascript">


			$("#btn-delete-all").hide();

			$(document).on('click', ".header", function() {   				
			    $header = $(this);
			    $content = $header.next();
			    $content.slideToggle(200, function () {			        
			    });
			});
	
		
			$('#check-all').change(function () {

				if($('#check-all').is(':checked')) {
				    $("#btn-delete-all").show();
				    $('.check-score').prop('checked', true);
				} else {
				    $("#btn-delete-all").hide();
				    $('.check-score').prop('checked', false);
				}

			});


			$("#btn-delete-all").click(function(){

				deleteAll();			

			});


			function showDeleteAllButton(){

				var chk = document.getElementsByClassName("check-score");
				var checked_items = 0;

				for (i = 0; i < chk.length; i++) { 

					if(chk[i].checked){
						checked_items++;
					}

				}

				if(checked_items>0){
					$("#btn-delete-all").show();
				} else {
					$("#btn-delete-all").hide();
				}

			}

			var url = "http://"+window.location.host+"/"+window.location.pathname.split('/')[1];

			$("#btn-load").click(function(){

				$('#table-resultset').attr('border', '1');
	    		$("#table-resultset tr").remove();
	    		$("#table-resultset thead").empty();
	    		$("#table-resultset thead").append("<th width='1%'></th><th width='5%'></th><th width='40%'>Music Score</th><th width='15%'>Related Persons</th><th width='15%'>Movements</th><th width='1%'></th>");

				$.getJSON(url+"?source="+$('#ds').val()+"&request=ListScores&pageSize=" + $('#page_size').val(), function(data){

					var sources = data["datasources"];

					for (i = 0; i < sources.length; i++) { 
        	 			
        	 			var src = sources[i];
        	 			
        	 			if(src["identifier"]==$('#ds').val()){

        	 				var scores = src["scores"];

							for (j = 0; j < scores.length; j++) { 

								var sc = scores[j];


								var formats = sc["formats"];
								var formats_string = "";

								for (k = 0; k < formats.length; k++) { 

									var fr = formats[k];
									var badge_color = "";
									if (fr["formatId"]=="musicxml"){
										badge_color="#468847";
									} else if (fr["formatId"]=="mei"){
										badge_color="#f89406";
									} else {
										badge_color="#999999";
									}
									formats_string = formats_string + '<span class="badge" style="background-color: '+badge_color+' ">'+fr["formatDescription"]+'</span>';

								}							

								var persons = sc["persons"];
								var persons_string = "";

								for (k = 0; k < persons.length; k++) { 

        	 						var per = persons[k];
        	 						var badge_color;

        	 						if(per["role"]=='Composer'){
        	 							badge_color = '#3a87ad';
        	 						} else {
        	 							badge_color = '#999999';
        	 						} 

        	 						persons_string = persons_string +'<p><a href="'+per["url"]+'">' + per["name"] + '</a> <span style="background-color: '+badge_color+'" class="badge">'+per["role"]+'</span></p>';

        	 					}
        	 				        	 					
        	 					var movements = sc["movements"];
        	 					var movements_string = "";

        	 					for (k = 0; k < movements.length; k++) { 

        	 						var mov = movements[k];
        	 						movements_string = movements_string + mov["movementName"] + "<br>";
        	 						var div = document.createElement("div");
        	 						div.innerHTML = "Replace with description.";

        	 					}
					
        	 					$('#table-resultset').append('<tr id="'+j+'" class="row-score">' +
        	 					'<td style="text-align: center;"><input id="check-'+j+'" type="checkbox" class="check-score" onclick="showDeleteAllButton();"/></td>'+
        	 					'<td style="text-align: center;"><img style="max-width: 125px" src="'+ sc["thumbnail"] + '"/></td>' +        	 					
        	 					'<td><form class="form-horizontal">'+
								'	  <div class="form-group">'+
								'	    <label class="control-label col-sm-2" for="email">Identifier:</label>'+
								'	    <div id ="score_id_container" class="col-sm-10"><p id="score_id_'+j+'" class="form-control-static">'+sc["scoreIdentifier"] +'</p></div>'+
								'		<label class="control-label col-sm-2" for="email">Title:</label>'+
								'	    <div class="col-sm-10"><p id="score_title_'+j+'" class="form-control-static">'+sc["title"] +'</p></div>'+
								'		<label class="control-label col-sm-2" for="email">Issued:</label>'+
								'	    <div class="col-sm-10"><p class="form-control-static">'+sc["dateIssued"] +'</p></div>'+

								'		<label class="control-label col-sm-2" for="email">Formats:</label>'+
								'	    <div class="col-sm-10"><p class="form-control-static">'+formats_string +'</p></div>'+

								'		<label class="control-label col-sm-2" for="email">Online Resource:</label>'+
								'	    <div class="col-sm-10"><p class="form-control-static"><a href="'+ sc["onlineResource"] + '">'+sc["onlineResource"]+'</a></p></div>'+
								'	  </div>'+
								'	</form>'+
								'</td> ' + 
	                			'<td>'+ persons_string + '</td>' +
	                			'<td id="mov_'+j+'"></td>'+
	             				'<td style="text-align: center;"><a href="javascript:deleteScore(\''+j+'\')"><p id="del_'+j+'" data-placement="top" data-toggle="tooltip" title="Delete"><button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete" ><span class="glyphicon glyphicon-trash"></span></button></p></a></td>' +
	             				'</tr>');

	             				for (k = 0; k < movements.length; k++) { 

        	 						var mov = movements[k];

        	 						$('<div>'+
		                				'<div class="panel-group">'+
	    									'<div class="panel panel-default">'+
				                				'<div class="panel-heading">'+
			        	 							'<h5 class="panel-title">'+
			        	 								'<a data-toggle="collapse" href="#perf_'+j+k+'">'+mov["movementName"]+'</a>'+
			        	 						  	'</h5>'+
												  	'<div id="perf_'+j+k+'" class="panel-collapse collapse"></div>'+
												'</div>'+
										    '</div>'+
										'</div>'+
									'</div>').appendTo('#mov_'+j);

        	 						var perf_type = mov["performanceMediumList"];

        	 						for (l = 0; l < perf_type.length; l++) { 
									
        	 							var perf = perf_type[l];
        	 							var medium = perf["mediums"];
       	 							
        	 							for (m = 0; m < medium.length; m++) { 

        	 								var med = medium[m];
        	 								$('<div class="panel-body">'+med["mediumScoreDescription"]+' ('+med["mediumDescription"]+')</div>').appendTo('#perf_'+j+k);
        	 								
        	 							}
        	 						}
        	 					}
        	 				}
        	 			}
        	 		}
				});
			});


			function deleteAll(){


				$.confirm({
				    title: 'Multiple Delete: ' + $('#table-resultset tr').filter(':has(:checkbox:checked)').length + ' Scores',
				    content: 'Are you sure you want to delete the selected scores? Think twice: this operation <b>cannot<b> be undone.',
				    buttons: {
				        cancel: function () {
				            
				        },
				        somethingElse: {
				            text: 'Delete',
				            btnClass: 'btn-red',
				            keys: ['enter', 'shift'],
				            action: function(){

								$('#table-resultset tr').filter(':has(:checkbox:checked)').each(function() {

									var row = this;
									$('#del_'+row.id).empty();
									$('#del_'+row.id).append('<div class="spinner-border text-danger"></div>');

									$.getJSON(url+'?source='+$('#ds').val()+'&request=DeleteScore&identifier='+$('#score_id_'+row.id).text(), function(data){

										if(data["type"]=='DeleteScoresReport'){						
											row.parentNode.removeChild(row);
											$("#btn-delete-all").hide();
											$('.check-score').prop('checked', false);
										} else {
												
											$('#del_'+row.id).append('<button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete">'+
																'	<span class="glyphicon glyphicon-trash"></span>'+
																'</button>');
											$("#btn-delete-all").show();
											$('.check-score').prop('checked', true);
										}
									});
								});		
				            }
				        }
				    }
				});
			}


			
			function deleteScore(row_number){

				var row = document.getElementById(row_number);

				$.confirm({
				    title: 'Delete Score',
				    content: 'Are you sure you want to delete this music score? This operation <b>cannot</b> be undone!<br><br>' + $('#score_title_'+row_number).text(),
				    buttons: {
				        delete: {
				        	btnClass: 'btn-red',
				        	action: function () {
				
							$('#del_'+row_number).empty();
							$('#del_'+row_number).append('<div class="spinner-border text-danger"></div>');

							$.getJSON(url+'?source='+$('#ds').val()+'&request=DeleteScore&identifier='+$('#score_id_'+row_number).text(), function(data){

								if(data["type"]=='DeleteScoresReport'){						
									row.parentNode.removeChild(row);
								} else {
									$.alert('Music score could not be deleted.');									
									$('#del_'+row_number).append('<button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete">'+
																	'<span class="glyphicon glyphicon-trash"></span>'+
																 '</button>');
								}
							});

				        }},

				        cancel: function () {

				        }
				    }
				});


			}

		</script>



	</body>	


</html>
