<!DOCTYPE html>
<html lang="en">
	<head>	
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

 		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

	</head>

	<body>			
		<h2>WMSS Score Management</h2>
		Data Source: 
		<select id="ds">
			<option>neo4j_local</option>
		</select> 
		Page size: <input id="page_size" value="15"></input>
		<button id="btnLoad">Load</button> <br/><br>

		<div class="table-responsive">
			<table id="tbRedsult" class="table table-bordred table-striped">
				<thead></thead>
				<tbody></tbody>
			</table>
		</div>

		<script type="text/javascript">


			$(document).on('click', ".header", function() {   				
			    $header = $(this);
			    $content = $header.next();
			    $content.slideToggle(200, function () {			        
			    });
			});

			var url = "http://"+window.location.host+"/"+window.location.pathname.split('/')[1];

			$("#btnLoad").click(function(){

				$('#tbRedsult').attr('border', '1');
	    		$("#tbRedsult tr").remove();


				$.getJSON(url+"?source="+$('#ds').val()+"&request=ListScores&pageSize=" + $('#page_size').val(), function(data){

					var sources = data["datasources"];

					for (i = 0; i < sources.length; i++) { 
        	 			
        	 			var src = sources[i];
        	 			
        	 			if(src["identifier"]==$('#ds').val()){

        	 				var scores = src["scores"];

							for (j = 0; j < scores.length; j++) { 

								var sc = scores[j];

								var persons = sc["persons"];
								var persons_string = "";

								for (k = 0; k < persons.length; k++) { 

        	 						var per = persons[k];
        	 						var badge_class;

        	 						if(per["role"]=='Composer'){
        	 							badge_class = 'badge badge-pill badge-primary';
        	 						} else {
        	 							badge_class = 'badge badge-pill badge-primary';
        	 						} 

        	 						persons_string = persons_string +'<p>' + per["name"] + ' <span class="'+badge_class+'">'+per["role"]+'</span></p>';

        	 					}
        	 				        	 					
        	 					var movements = sc["movements"];
        	 					var movements_string = "";

        	 					for (k = 0; k < movements.length; k++) { 

        	 						var mov = movements[k];
        	 						movements_string = movements_string + mov["movementName"] + "<br>";
        	 						var div = document.createElement("div");
        	 						div.innerHTML = "Replace with description.";

        	 					}
					
        	 					$('#tbRedsult').append('<tr id="'+sc["scoreIdentifier"]+'">' +
        	 					'<td><input type="checkbox" class="checkthis" /></td>'+
        	 					'<td><img style="max-width: 125px" src="'+ sc["thumbnail"] + '"/></td>' +
        	 					'<td><b>Identifier</b>: '+sc["scoreIdentifier"] + 
	        	 					'<br><b>Title</b>: '+ sc["title"] +
	        	 					'<br><b>Issued</b>: '+ sc["dateIssued"] +
	        	 					'<br><b>Online Resource</b>: <a href="'+ sc["onlineResource"] + '">'+sc["onlineResource"]+'</a>'+
        	 					'</td>' + 
	                			'<td>'+ persons_string + '</td>' +               		
	                			
	                			'<td id="mov_'+j+'">'+
                				
	                			'</td>' +

	             				'<td><a href="javascript:deleteScore(\''+sc["scoreIdentifier"]+'\',\''+sc["title"]+'\')"><p data-placement="top" data-toggle="tooltip" title="Delete"><button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete" ><span class="glyphicon glyphicon-trash"></span></button></p></a></td>' +
	             				'</tr>');

	             				for (k = 0; k < movements.length; k++) { 

        	 						var mov = movements[k];

        	 						$('<div class="container">'+
		                				'<div class="panel-group">'+
	    									'<div class="panel panel-default">'+
				                				'<div class="panel-heading">'+
			        	 							'<h4 class="panel-title">'+
			        	 								'<a data-toggle="collapse" href="#perf_'+j+k+'">'+mov["movementName"]+'</a>'+
			        	 						  	'</h4>'+
												  	'<div id="perf_'+j+k+'" class="panel-collapse collapse">'+
							      				  	'</div>'+
												'</div>'+
										    '</div>'+
										'</div>'+
									'</div>'
									).appendTo('#mov_'+j);

        	 						var perf_type = mov["performanceMediumList"];

        	 						for (l = 0; l < perf_type.length; l++) { 
									
        	 							var perf = perf_type[l];
        	 							var medium = perf["mediums"];
       	 							
        	 							for (m = 0; m < medium.length; m++) { 

        	 								var med = medium[m];
        	 								$('<div class="panel-body">'+med["mediumScoreDescription"]+' ('+med["mediumDescription"]+')</div>').appendTo('#perf_'+j+k);
        	 								
        	 							}

        	 						}
        	 					}

        	 				}

        	 			}
        	 		}
				});

			});


			function deleteScore(identifier,title){

				$.confirm({
				    title: 'Are you sure you want to delete this music score? This operation <b>cannot</b> be undone!',
				    content: 'Identifier: '+identifier+'<br>Title: '+title,
				    buttons: {
				        confirm: {
				        	btnClass: 'btn-red',
				        	action: function () {
				            
				            var row = document.getElementById(identifier);
							row.getElementsByTagName('td')[4].innerHTML="Working ..";


							$.getJSON(url+'?source='+$('#ds').val()+'&request=DeleteScore&identifier='+identifier, function(data){
								if(data["type"]=='DeleteScoresReport'){						
									row.parentNode.removeChild(row);
								} else {
									$.alert('Music score could not be deleted.');									
									row.getElementsByTagName('td')[5].innerHTML='<a href="javascript:deleteScore(\''+identifier+'\')">Delete</a>';
								}
							});

				        }},

				        cancel: function () {
				            
				        }
				    }
				});


			}

		</script>



	</body>	


</html>
