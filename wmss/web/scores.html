<!DOCTYPE html>
<html lang="en">
	<head>	
	</head>
	<body>			
					
		    
		    <div class="input-group w-50 table">

		      <input type="text" placeholder="Title" class="form-control" id="title" style="margin-left: none;">
		 
		      	<button id="btn-load" class="btn btn-primary btn-space" type="button" style="margin-left: 10px;" onclick="loadData()">
					    <i class="fas fa-search"></i>
				</button>
				<button class="btn btn-primary btn-space" style="margin-left: 10px;" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
					    <i class="fas fa-plus"></i>
				</button>
		    </div>

			<div class="collapse" id="collapseExample" >			
			  <div class="card card-body">
				<table class="table">
					<tr>
						<td width="20%">
							<label for="collections" class="w-100">Collections
								<select class="custom-select" id="collections"><option selected></option></select>
							</label>
						</td>
						<td width="20%">
							<label for="collections" class="w-100">Persons
								<select class="custom-select" id="persons"><option selected></option></select>
							</label>
						</td>
						<td width="20%">
							<label for="collections" class="w-100">Instrument Group
								<select class="custom-select" id="instruments-group"><option selected></option></select>
							</label>							
						</td>
						<td width="20%">
							<label for="collections" class="w-100">Instruments
								<select class="custom-select" id="instruments"><option selected></option></select>
							</label>
						</td>
						<td width="20%">
							<label for="collections" class="w-100">Formats
								<select class="custom-select" id="formats"><option selected></option></select>
							</label>
						</td>						
					</tr>
				</table>

				<table class="table">
					<tr>
						<td class="keyboard w-25" style="text-align: center;">							
							<div style="padding-bottom: 10px">	
								<button type="button" class="btn btn-light btn-sm" onclick="setOctave('down')">
									<i class="fas fa-chevron-down"></i>
									<span id="down-octave">4</span>
								</button>

									<button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px" onclick="javascript:onduration(9)">
		                              <img src="img/double-whole.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px" onclick="javascript:onduration(1)">
		                           		<img src="img/whole.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px"onclick="javascript:onduration(2)">
		                            	<img src="img/half.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration border border-primary" style="padding: 5px" onclick="javascript:onduration(4)">
		                            	<img src="img/quarter.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px"onclick="javascript:onduration(8)">
		                              <img src="img/eighth.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px"onclick="javascript:onduration(6)">
		                              <img src="img/16th.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px"onclick="javascript:onduration(3)">
		                              <img src="img/32nd.png">
		                            </button>
		                            <button type="button" class="btn btn-light btn-sm note-duration" style="padding: 5px;"onclick="javascript:onduration(5)">
		                              <img src="img/64th.png">
		                            </button>
		                        
		                        <div class="btn-group">
		                            <button type="button" class="btn btn-light btn-sm" style="padding: 5px;" onclick="javascript:onrest()">
		                              <i class="fas fa-pause"></i>
		                            </button>
			                    </div>
		                        <div class="btn-group">
		                            <button id="btn-dot" type="button" class="btn btn-light btn-sm" style="padding: 5px;" onclick="javascript:ondot()">
		                              <i class="fas fa-ellipsis-h"></i>
		                            </button>
		                        </div>
   		                        <div class="btn-group">
		                            <button id="btn-grace" type="button" class="btn btn-light btn-sm" style="padding: 5px;" onclick="javascript:ongrace()">
		                              <i class="fab fa-glide-g"></i>
		                            </button>
		                        </div>

		                        <div class="btn-group">
		                            <button id="btn-measure" type="button" class="btn btn-light btn-sm" style="padding: 5px;" onclick="javascript:onbarline()">
		                              <i class="fas fa-ruler-horizontal"></i>
		                            </button>
		                        </div>
		                        <div class="btn-group">
		                            <button id="btn-chord" type="button" class="btn btn-light btn-sm" style="padding: 5px;">
		                              <i class="fas fa-guitar"></i>
		                            </button>
		                        </div>
		                        <button type="button" class="btn btn-light btn-sm" onclick="setOctave('up')" style="padding: 5px;">
									<i class="fas fa-chevron-up"></i>
									<span id="up-octave">6</span>
								</button>
		                    </div>
								

							<map id="piano_map" name="piano_map">
			                    
			                    <area shape="rect" coords="17,3,32,52" href="javascript:onpitch('C', 'min', 1, 61);" />
			                    <area shape="rect" coords="42,3,57,52" href="javascript:onpitch('D', 'min', 1, 63)"/>
			                    <area shape="rect" coords="92,3,107,52" href="javascript:onpitch('F', 'min', 1, 66)" />
			                    <area shape="rect" coords="117,3,132,52" href="javascript:onpitch('G', 'min', 1, 68)" />
			                    <area shape="rect" coords="142,3,157,52" href="javascript:onpitch('A', 'min', 1, 70)" />

			                    <area shape="rect" coords="17,53,32,102" href="javascript:onpitch('D', 'min', -1, 61)" />
			                    <area shape="rect" coords="42,53,57,102" href="javascript:onpitch('E', 'min', -1, 63)" />
			                    <area shape="rect" coords="92,53,107,102" href="javascript:onpitch('G', 'min', -1, 66)" />
			                    <area shape="rect" coords="117,53,132,102" href="javascript:onpitch('A', 'min', -1, 68)" />
			                    <area shape="rect" coords="142,53,157,102" href="javascript:onpitch('B', 'min', -1, 70)" />

			                    <area shape="rect" coords="1,3,25,152" href="javascript:onpitch('C', 'min', 0, 60)" />
			                    <area shape="rect" coords="26,3,50,152" href="javascript:onpitch('D', 'min', 0, 62)" />
			                    <area shape="rect" coords="51,3,75,152" href="javascript:onpitch('E', 'min', 0, 64)" />
			                    <area shape="rect" coords="76,3,100,152" href="javascript:onpitch('F', 'min', 0, 65)" />
			                    <area shape="rect" coords="101,3,125,152" href="javascript:onpitch('G', 'min', 0, 67)" />
			                    <area shape="rect" coords="126,3,150,152" href="javascript:onpitch('A', 'min', 0, 69)" />
			                    <area shape="rect" coords="151,3,175,152" href="javascript:onpitch('B', 'min', 0, 71)" />

			                    <area shape="rect" coords="192,3,207,52" href="javascript:onpitch('C', 'med', 1, 73)" />
			                    <area shape="rect" coords="217,3,232,52" href="javascript:onpitch('D', 'med', 1, 75)" />
			                    <area shape="rect" coords="267,3,282,52" href="javascript:onpitch('F', 'med', 1, 78)" />
			                    <area shape="rect" coords="292,3,307,52" href="javascript:onpitch('G', 'med', 1, 80)" />
			                    <area shape="rect" coords="317,3,332,52" href="javascript:onpitch('A', 'med', 1, 82)"  />

			                    <area shape="rect" coords="192,53,207,102" href="javascript:onpitch('D', 'med', -1, 73)" />
			                    <area shape="rect" coords="217,53,232,102" href="javascript:onpitch('E', 'med', -1, 75)" />
			                    <area shape="rect" coords="267,53,282,102" href="javascript:onpitch('G', 'med', -1, 78)" />
			                    <area shape="rect" coords="292,53,307,102" href="javascript:onpitch('A', 'med', -1, 80)" />
			                    <area shape="rect" coords="317,53,332,102" href="javascript:onpitch('B', 'med', -1, 82)" />

			                    <area shape="rect" coords="176,3,200,152" href="javascript:onpitch('C', 'med', 0, 72)" />
			                    <area shape="rect" coords="201,3,225,152" href="javascript:onpitch('D', 'med', 0, 74)" />
			                    <area shape="rect" coords="226,3,250,152" href="javascript:onpitch('E', 'med', 0, 76)" />
			                    <area shape="rect" coords="251,3,275,152" href="javascript:onpitch('F', 'med', 0, 77)" />
			                    <area shape="rect" coords="276,3,300,152" href="javascript:onpitch('G', 'med', 0, 79)" />
			                    <area shape="rect" coords="301,3,325,152" href="javascript:onpitch('A', 'med', 0, 81)" />
			                    <area shape="rect" coords="326,3,350,152" href="javascript:onpitch('B', 'med', 0, 83)" />

			                    <area shape="rect" coords="367,3,382,52" href="javascript:onpitch('C', 'max', 1, 85)" />
			                    <area shape="rect" coords="392,3,407,52" href="javascript:onpitch('D', 'max', 1, 87)" />
			                    <area shape="rect" coords="442,3,457,52" href="javascript:onpitch('F', 'max', 1, 90)" />
			                    <area shape="rect" coords="467,3,482,52" href="javascript:onpitch('G', 'max', 1, 92)" />
			                    <area shape="rect" coords="492,3,507,52" href="javascript:onpitch('A', 'max', 1, 94)" />

			                    <area shape="rect" coords="367,53,382,102" href="javascript:onpitch('D', 'max', -1, 85)" />
			                    <area shape="rect" coords="392,53,407,102" href="javascript:onpitch('E', 'max', -1, 87)" />
			                    <area shape="rect" coords="442,53,457,102" href="javascript:onpitch('G', 'max', -1, 90)" />
			                    <area shape="rect" coords="467,53,482,102" href="javascript:onpitch('A', 'max', -1, 92)" />
			                    <area shape="rect" coords="492,53,507,102" href="javascript:onpitch('B', 'max', -1, 94)" />

			                    <area shape="rect" coords="351,3,375,152" href="javascript:onpitch('C', 'max', 0, 84)" />
			                    <area shape="rect" coords="376,3,400,152" href="javascript:onpitch('D', 'max', 0, 86)" />
			                    <area shape="rect" coords="401,3,425,152" href="javascript:onpitch('E', 'max', 0, 88)" />
			                    <area shape="rect" coords="426,3,450,152" href="javascript:onpitch('F', 'max', 0, 89)" />
			                    <area shape="rect" coords="451,3,475,152" href="javascript:onpitch('G', 'max', 0, 91)" />
			                    <area shape="rect" coords="476,3,500,152" href="javascript:onpitch('A', 'max', 0, 93)" />
			                    <area shape="rect" coords="501,3,525,152" href="javascript:onpitch('B', 'max', 0, 95)" />

		                	</map>
		                	<img id="piano_img" src="img/piano-notes.png" usemap="#piano_map"/>

							<div class="w-100 mx-auto" style="margin-top: 15px;">

								<div id="container-check-chords" style="padding-right: 5px; float: left" class="custom-control custom-checkbox">
									<input id="check-ignore-chords" type="checkbox" class="custom-control-input" checked/>
									<label class="custom-control-label" for="check-ignore-chords">Ignore Chords  </label>
								</div>
								
								<div id="container-check-octave" style="padding-right: 5px; float: left;" class="custom-control custom-checkbox">
									<input id="check-ignore-octave" type="checkbox" class="custom-control-input" checked/>
									<label class="custom-control-label" for="check-ignore-octave">Ignore Octave</label>
								</div>
								
								<div id="container-check-duration" style="padding-right: 5px; float: left;" class="custom-control custom-checkbox">
									<input id="check-ignore-duration" type="checkbox" class="custom-control-input"/>
									<label class="custom-control-label" for="check-ignore-duration">Ignore Duration  </label>
								</div>
								
								<div id="container-check-pitch" style="padding-right: 5px; float: left;" class="custom-control custom-checkbox">
									<input id="check-ignore-pitch" type="checkbox" class="custom-control-input"/>
									<label class="custom-control-label" for="check-ignore-pitch">Ignore Pitch</label>
								</div>

							</div>							
						</td>
						<td>
                    		<p>
		                    	<select id="clef_01" name="clef_01" class="custom-select">
		                            <option value="G-1">G-1</option>
		                            <option value="G-2" selected="true">G-2 (treble)</option>
		                            <option value="C-1">C-1</option>
		                            <option value="C-2">C-2</option>
		                            <option value="C-3">C-3</option>
		                            <option value="C-4">C-4</option>
		                            <option value="C-5">C-5</option>
		                            <option value="F-4">F-4 (bass)</option>
		                            <option value="F-3">F-3</option>
		                        </select>
                    		</p>
                    		<p>
                    			<select class="custom-select" id="tonalities"><option value="disabled" disabled selected>Key Signature</option></select>
                    		</p>
							<p>
                        		<input type="input" id="timesig_01" name="timesig_01" class="form-control" placeholder="Time signature (e.g. c c/ 3/4)"/>
                    		</p>
                    		<p>
								<div><input type="input" id="incipit_01" name="incipit_01" class="form-control" placeholder="Plaine &amp; Easie code ..." /></div>
							</p>							

						</td>
					</tr>
					<tr>
						<td class="keyboard" style="text-align: center;">							
							<div style="text-align: center;  display:inline;" id="render_01"></div>							
						</td>
						<td></td>
					</tr>
				</table>

				<div class="panel-body" hidden="true">
                 	<pre class="prettyprint" id="mei_output"  style="overflow: auto; width: auto; word-wrap: normal; display: none;"></pre>
            	</div>
					
			    Request: <code><span id="request-url"></span></code>
			     
			  </div>
			</div>
	
		
		<div class="input-group col-md-8 table" style="margin-top: 15px;">
			<div id="container-check-all" class="custom-control custom-checkbox">
				<input class="custom-control-input check-file" id='check-all' type='checkbox'/>
				<label class="custom-control-label" for="check-all"></label>
			</div>
			<button id="btn-delete-all" style="margin-left: 10px;" class="btn btn-danger" data-title="Delete" data-toggle="modal" data-target="#delete"><i class="fa fa-trash" aria-hidden="true"></i>    Delete</button>
		</div>

		<table id="table-resultset" class="table table-striped table-bordered">
		</table>
	
		<br><br><br><br>	
	
	<script>


    var current_oct = -1;
    var current_duration = 4;
    var current_dot = 0;
    var current_chord = 0;
    var current_grace = 0;
    var undos = new Array();

	var min_octave = 4;
	var med_octave = 5;
	var max_octave = 6;

	$("#btn-delete-all").hide();

	$(document).on('click', ".header", function() {   				
	    $header = $(this);
	    $content = $header.next();
	    $content.slideToggle(200, function () {			        
	    });
	});


	$('.note-duration').click(function (){
		$('.note-duration').removeClass('border border-primary');
		$(this).addClass('border border-primary');		
		
	});


	$('#btn-chord').click(function (){		
		if(current_chord==0){
			$('#btn-chord').addClass('border border-primary');	
			current_chord = 1;
		} else {
			$('#btn-chord').removeClass('border border-primary');
			current_chord = 0;
		}
	});

	$('#btn-grace').click(function (){		
		if(current_grace==0){
			$('#btn-grace').addClass('border border-primary');	
			current_grace = 1;
		} else {
			$('#btn-grace').removeClass('border border-primary');
			current_grace = 0;
		}
	});

	$('#check-all').change(function () {

		if($('#check-all').is(':checked')) {
		    $("#btn-delete-all").show();
		    $('.check-score').prop('checked', true);
		} else {
		    $("#btn-delete-all").hide();
		    $('.check-score').prop('checked', false);
		}

	});


	$("#btn-delete-all").click(function(){

		deleteAll();			

	});

	function loadFilters(){

		$.getJSON(base_url+"?request=DescribeService", function(data){

			sources = data["datasources"];
			
	        for (i = 0; i < sources.length; i++) { 

	        	var src = sources[i];

	        	if(src["id"]==current_source){

		        	var collections = src["collections"];
		        	for (j = 0; j < collections.length; j++) { 
		        		var col = collections[j];
		        	 	var o = new Option(col["description"],col["id"]);
		        	 	$('#collections').append(o); 
		        	}

		        	var persons = src["persons"];
		        	for (j = 0; j < persons.length; j++) { 
		        		var col = persons[j];
		        	 	var o = new Option(col["name"] + ' ('+col["role"]+')',col["url"]);
		        	 	$('#persons').append(o); 
		        	}
		        	
		        	var tonalities = src["tonalities"];
		        	for (j = 0; j < tonalities.length; j++) { 
		        		var col = tonalities[j];
		        	 	var o = new Option(col["tonic"] + ' ' + col["mode"], col["code"]);
		        	 	$('#tonalities').append(o); 
		        	}

		        	var formats = src["formats"];
		        	for (j = 0; j < formats.length; j++) { 
		        		var frm = formats[j];
		        	 	var o = new Option(frm["formatDescription"],frm["formatId"]);
		        	 	$('#formats').append(o); 
		        	}

		        	var performance_mediums = src["performanceMediums"];

		        	for (j = 0; j < performance_mediums.length; j++) {

		        		var performance_mediums_group = performance_mediums[j]["mediumTypeDescription"];
		        		var g = new Option(performance_mediums[j]["mediumTypeDescription"].charAt(0).toUpperCase() + performance_mediums[j]["mediumTypeDescription"].slice(1),performance_mediums[j]["mediumTypeDescription"]);
		        		$('#instruments-group').append(g);

		        		var mediums = performance_mediums[j]["mediums"];	        									
						
						for (k = 0; k < mediums.length; k++) {

			        		var med = mediums[k];
			        	 	var o = new Option(med["mediumDescription"], med["mediumCode"]);
			        	 	$('#instruments').append(o); 

						} 		        		

		        	}


	        	}

	        }

		});
	}

	$( document ).ready(function() {

		loadFilters();
		$('#container-check-all').hide();	

	});

	function showDeleteAllButton(){

		var chk = document.getElementsByClassName("check-score");
		var checked_items = 0;

		for (i = 0; i < chk.length; i++) { 

			if(chk[i].checked){
				checked_items++;
			}

		}

		if(checked_items>0){
			$("#btn-delete-all").show();
		} else {
			$("#btn-delete-all").hide();
		}

	}

			


		




	var url = "http://"+window.location.host+"/"+window.location.pathname.split('/')[1];
	var totalSize = 0;  		
	var current_page = 1;
	
	var datatable;


	$(document).on('mouseup', 'a.page-link:not(.next):not(.previous)', function() {   						
   		current_page = parseInt($(this).attr('data-dt-idx'));
    	console.log('current_page index > '+current_page);		
	});

	$(document).on('mouseup', 'li.paginate_button.next', function() {   						
   		current_page = parseInt($('li.paginate_button.page-item.active a.page-link').attr('data-dt-idx'))+1;
    	console.log('current_page next > '+(current_page+1));		
	});

	$(document).on('mouseup', 'li.paginate_button.previous', function() {   						
   		current_page = parseInt($('li.paginate_button.page-item.active a.page-link').attr('data-dt-idx'))-1;
    	console.log('current_page next > '+(current_page-1));		
	});

	$('#title').bind('keyup', function(e) {
	   if(e.keyCode == 13) {
		    loadData();
		}
	}); 

	function loadData(){

		var page_size = 10;
  		
  		$('#container-check-all').show();

  		if ( $.fn.DataTable.isDataTable( '#table-resultset' ) ) {
  			current_page=1;  			
		}

		var request_url = url+"?source="+current_source+"&request=ListScores";
		
		if($('#incipit_01').val()!=''){
			
			request_url = request_url +'&melody='+$('#incipit_01').val();

			if($('#check-ignore-octave').prop('checked')) {
				request_url = request_url +'&ignoreOctave=true';
			} else {
				request_url = request_url +'&ignoreOctave=false';
			}

			if($('#check-ignore-pitch').prop('checked')) {
				request_url = request_url +'&ignorePitch=true';
			} else {
				request_url = request_url +'&ignorePitch=false';
			}

			if($('#check-ignore-duration').prop('checked')) {
				request_url = request_url +'&ignoreDuration=true';
			} else {
				request_url = request_url +'&ignoreDuration=false';
			}

			if($('#check-ignore-chords').prop('checked')) {
				request_url = request_url +'&ignoreChords=true';
			} else {
				request_url = request_url +'&ignoreChords=false';
			}

		}

		if($('#tonalities').val()!=null){
			request_url = request_url +'&key='+$('#tonalities').val();
		}		

		if($('#collections').val()!=''){
			request_url = request_url +'&collection='+$('#collections').val();
		}

		if($('#persons').val()!=''){
			request_url = request_url +'&person='+$('#persons').val();
		}

		if($('#title').val()!=''){
			request_url = request_url +'&title='+$('#title').val();
		}

		if($('#formats').val()!=''){
			request_url = request_url +'&format='+$('#formats').val();
		}

		if($('#instruments').val()!=''){
			request_url = request_url +'&performanceMedium='+$('#instruments').val();
		}

		if($('#instruments-group').val()!=''){
			request_url = request_url +'&performanceMediumType='+$('#instruments-group').val();
		}

		if($('#timesig_01').val()!=''){
			request_url = request_url +'&time='+$('#timesig_01').val();
		}

		$('#request-url').text(request_url);



		datatable = $('#table-resultset').dataTable( {
		  	'destroy': true,
		  	'serverSide': true,
		  	'filter': true,
		  	"processing": true,
		  	"ordering": false,
		  	"searching": false,
		  	"language": {
		  		 "processing": '<i class="fa fa-spinner fa-spin fa-5x" style="top: 0; background:transparent;"></i>'
  			},
		  	'ajax': {
		  	'data': function (data) {
            	data.offset = (page_size*current_page)-page_size;
            	data.pageSize = data.length;
            	data.totalSize = totalSize;
            	if($('.form-control').val() != ''){
            		data.title = $('#table-resultset_filter input').val();
            	}
            },
            'createdRow': function( row, data, dataIndex ) {
    			  $(row).attr('id', 'someID');
  			},
		    'url': request_url,
		    'dataSrc': function (json) {
     		    	        		      		
		     	var return_data = new Array();
		    	var sources = json["datasources"];	    	

		    	console.log(json);

				if(json["type"]!='ScoreListReport'){

					$.alert({
						icon: 'fa fa-times',
						type: 'red',
					    title: 'Error',
					    content: 'Code: ' + json["code"] + '<br>Message: '+ json["message"] + '<br><br>'+json["hint"],
					});

				} else {

					for (i = 0; i < sources.length; i++) {     	 			
				        
				        var src = sources[i];
		
	    	 			if(src["identifier"]==current_source){

	    	 				totalSize = parseInt(src["totalSize"]);
					      	json['recordsTotal'] = src["totalSize"];
		      				json['recordsFiltered'] = src["totalSize"];
	    	 				
	    	 				var scores = src["scores"];

							for (j = 0; j < scores.length; j++) { 

								var sc = scores[j];
								var collection = sc["collection"];
								var formats = sc["formats"];
								var formats_string = "";

								for (k = 0; k < formats.length; k++) { 

									var fr = formats[k];
									var badge_class = "";
									if (fr["formatId"]=="musicxml"){
										badge_class="badge badge-info";
									} else if (fr["formatId"]=="mei"){
										badge_class="badge badge-secondary";
									} else {
										badge_class="badge badge-dark";
									}
									formats_string = formats_string + '<a style="font-size:18px" href="javascript:getScore(\''+j+'\',\''+fr["formatId"]+'\')"><span style="display: block;" class="'+badge_class+'"><i class="fa fa-download"/> '+fr["formatDescription"]+'</span></a>';

								}							

								var persons = sc["persons"];
								var persons_string = "";

								for (k = 0; k < persons.length; k++) { 

	    	 						var per = persons[k];
	    	 						var badge_class;

	    	 						if(per["role"]=='Composer'){
	    	 							badge_class = 'badge badge-info';
	    	 						} else {
	    	 							badge_class = 'badge badge-secondary';
	    	 						} 

	    	 						persons_string = persons_string +'<p><a href="'+per["url"]+'">' + per["name"] + '</a> <span class="'+badge_class+'">'+per["role"]+'</span></p>';

	    	 					}






	    	 					var locations = sc["melodyLocations"];
	    	 					var melody_movement_string = "";

	    	 					for (k = 0; k < locations.length; k++) {

	    	 						var location_item = locations[k];
	    	 						var melodies = location_item["melodyLocation"];

	    	 						var location_string = '';

										for (l = 0; l < melodies.length; l++) {

											var loc = melodies[l];
											location_string = location_string + 
											'Instrument: <b>'+loc["instrumentName"] + '</b><br>'+
											'Measure: <b>'+loc["startingMeasure"] + '</b><br>'+
											'Voice: <b>'+loc["voice"] + '</b><br>'+
											'Staff: <b>'+loc["staff"]+'</b><br><br>';

										}
	    	 					
	    	 							melody_movement_string = melody_movement_string + 		 							
										'<div class="card">'+
										'  <div class="card-header bg-light" id="heading-location-'+j+k+'">'+								
										'      <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-location-'+j+k+'" aria-expanded="false" aria-controls="collapse-location-'+j+k+'" style="padding:0">'+
										'        '+location_item["movementName"]+
										'      </button>'+										
										'  </div>'+
										'  <div id="collapse-location-'+j+k+'" class="collapse hide" aria-labelledby="heading-location-'+j+k+'" data-parent="#locations-'+j+'">'+
										'    <div id="location-'+j+k+'" class="card-body"> '+ location_string+
												
										'    </div>'+
										'  </div>'+
										'</div>';
	    	 					} 


	    	 					if (melody_movement_string != ''){
	    	 						melody_movement_string = '<p>Melody Location</p><div id="locations-'+j+'" class="accordion">'+melody_movement_string+'</div><br>'; 
	    	 					}









								var movements = sc["movements"];
	    	 					var movements_string = "";

	    	 					for (k = 0; k < movements.length; k++) { 

	        	 						
			 						var mov = movements[k];
			 						var perf_type = mov["performanceMediumList"];

			 						var mediums_string = "<ul>";

			 						for (l = 0; l < perf_type.length; l++) { 
									
			 							var perf = perf_type[l];
			 							var medium = perf["mediums"];
				 						
			 							for (m = 0; m < medium.length; m++) { 

			 								var med = medium[m];        	 								
			 								mediums_string = mediums_string + '<li>' +med["mediumScoreDescription"]+' ('+med["mediumDescription"]+')</li>';
			 								
			 							}
			 						}

			 						mediums_string = mediums_string + "</ul>";

			 						movements_string = movements_string + 		 							
										'<div class="card">'+
										'  <div class="card-header" id="heading-'+j+k+'">'+
										'      <button class="btn btn-link" type="button" style="padding:0" data-toggle="collapse" data-target="#collapse-'+j+k+'" aria-expanded="false" aria-controls="collapse-'+j+k+'">'+
										'        '+mov["movementName"]+
										'      </button>'+
										'  </div>'+
										'  <div id="collapse-'+j+k+'" class="collapse hide" aria-labelledby="heading-'+j+k+'" data-parent="#movements-'+j+'">'+
										'    <div id="medium-'+j+k+'" class="card-body">'+ 
												mediums_string +
										'    </div>'+
										'  </div>'+
										'</div>';

			 					}
	    	 												
						        return_data.push({
						          'check': '<div id="container-check-all" class="custom-control custom-checkbox">'+
						          				'<input id="check-'+j+'" type="checkbox" class="check-score custom-control-input check-file" onclick="showDeleteAllButton();"/>'+
						          				'<label class="custom-control-label" for="check-'+j+'"></label>'+
						          			'</div>',
						          'thumbnail'  : '<img style="max-width: 125px" src="'+ sc["thumbnail"] + '"/>',
						          'score'  : '<form class="col-12">'+
									'	  <div class="form-row">'+
									'	    <label class="col-sm-2 col-form-label" for="identifier">Identifier:</label>'+
									'	    <div id ="score_id_container" class="col-sm-10"><p id="score_id_'+j+'" class="form-control-static">'+sc["scoreIdentifier"] +'</p></div>'+
									'	  </div>'+
									'	  <div class="form-row">'+
									'		<label class="col-sm-2 col-form-label" for="title">Title:</label>'+
									'	    <div class="col-sm-10"><p id="score_title_'+j+'" class="form-control-static">'+sc["title"] +'</p></div>'+
									'	  </div>'+
									'	  <div class="form-row">'+
									'		<label class="col-sm-2 col-form-label" for="issued">Issued:</label>'+
									'	    <div class="col-sm-10"><p class="form-control-static">'+sc["dateIssued"] +'</p></div>'+
									'	  </div>'+
									'	  <div class="form-row">'+
									'		<label class="col-sm-2 col-form-label" for="online-resource">Resource:</label>'+
									'	    <div class="col-sm-10"><p class="form-control-static"><a href="'+ sc["onlineResource"] + '">'+sc["onlineResource"]+'</a></p></div>'+
									'	  </div>'+
									'	  <div class="form-row">'+
									'		<label class="col-sm-2 col-form-label" for="online-resource">Collection:</label>'+
									'	    <div class="col-sm-10"><p class="form-control-static"><a href="'+ collection["id"] + '">'+collection["description"]+'</a></p></div>'+
									'	  </div>'+
									'	  <div class="form-row">'+
									'		<div class="col-sm-100"><p class="form-control-static" style="style: none;">'+ formats_string+'</p></div>'+								
									'	  </div>'+
									'	</form> ',
						          'persons'  : persons_string,
						          'movements'  : melody_movement_string+'<p>Movements</p><div id="movements-'+j+'" class="accordion">'+movements_string+'</div>',
						          'delete'  : '<a href="javascript:deleteScore(\''+j+'\')"><p id="del_'+j+'" data-placement="top" data-toggle="tooltip" title="Delete"><button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete" ><i class="fa fa-trash"/></button></p></a>',
							      'DT_RowId': ''+j+'',
							      'DT_RowClass': 'row-score'
						        });




							}
						}

				     }
									      	
			      	return return_data;

			    	}

			    }

	  		},
			  "columns" : [
			    {'data': 'check'},
			    {'data': 'thumbnail'},
			    {'data': 'score'},
			    {'data': 'persons'},
			    {'data': 'movements'},
			    {'data': 'delete'}]

		});

	}


	function getScore(row_number,format) {


		$('#get-score-'+row_number).empty();
		$('#get-score-'+row_number).append('<div class="spinner-border text-info"></div>');


		var dataUrl = url+'?source='+current_source+'&request=GetScore&identifier='+$('#score_id_'+row_number).text()+'&format='+format;
		var filename = $('#score_title_'+row_number);

		
		$('#request-url').text(url+'?source='+current_source+'&request=GetScore&identifier='+$('#score_id_'+row_number).text()+'&format='+format);
	    
	    var link = document.createElement("a");
	    link.download = filename;
	    link.target = "_blank";


	    link.href = dataUrl;
	    document.body.appendChild(link);
	    link.click();

	    document.body.removeChild(link);
	    delete link;

	    $('#get-score-'+row_number).empty();
		$('#get-score-'+row_number).append('<button class="btn btn-info btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
								 '	<i class="fa fa-download"/>'+
								 '</button>');

	}


	function deleteAll(){


		$.confirm({
		    title: 'Multiple Delete: ' + $('#table-resultset tr').filter(':has(:checkbox:checked)').length + ' Scores',
		    content: 'Are you sure you want to delete the selected scores? Think twice: this operation <b>cannot</b> be undone.',
		    buttons: {
		        cancel: function () {
		            
		        },
		        somethingElse: {
		            text: 'Delete',
		            btnClass: 'btn-red',
		            keys: ['enter', 'shift'],
		            action: function(){

						$('#table-resultset tr').filter(':has(:checkbox:checked)').each(function() {

							var row = this;
							$('#del_'+row.id).empty();
							$('#del_'+row.id).append('<div class="spinner-border text-danger"></div>');

							var delete_url = url+'?source='+current_source+'&request=DeleteScore&identifier='+$('#score_id_'+row.id).text();
							$('#request-url').text(delete_url);

							$.getJSON(delete_url, function(data){

								if(data["type"]=='DeleteScoresReport'){						
									row.parentNode.removeChild(row);
									$("#btn-delete-all").hide();
									$('.check-score').prop('checked', false);
								} else {
										
									$('#del_'+row.id).append('<button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
														'	<i class="fa fa-trash"/>'+
														'</button>');
									$("#btn-delete-all").show();
									$('.check-score').prop('checked', true);
								}
							});

							$('#check-all').prop('checked', false);
						});		
		            }
		        }
		    }
		});
	}

			
	function deleteScore(row_number){

		var row = document.getElementById(row_number);

		$.confirm({
		    title: 'Delete Score',
		    content: 'Are you sure you want to delete this music score? This operation <b>cannot</b> be undone!<br><br>' + $('#score_title_'+row_number).text(),
		    buttons: {
		        delete: {
		        	btnClass: 'btn-red',
		        	action: function () {
		
					$('#del_'+row_number).empty();
					$('#del_'+row_number).append('<div class="spinner-border text-danger"></div>');

					var delete_url = base_url+'?source='+current_source+'&request=DeleteScore&identifier='+$('#score_id_'+row_number).text();
					$('#request-url').text(delete_url);

					$.getJSON(delete_url, function(data){

						if(data["type"]=='DeleteScoresReport'){						

							row.parentNode.removeChild(row);
							showDeleteAllButton();
						} else {
							$.alert('Music score could not be deleted.<br>'+
								'<br><b>Code</b>: '+data["code"]+
								'<br><b>Message</b>: '+data["message"]);									
							$('#del_'+row_number).html('<button class="btn btn-danger btn-sm" data-title="Delete" data-toggle="modal" data-target="#delete">'+
															'<i class="fa fa-trash"/>'+
														 '</button>');
						}
					});

		        }},

		        cancel: function () {

		        }
		    }
		});

	}

	function setOctave(direction){

		if(direction=='up' && max_octave < 9){
			min_octave = min_octave +1;
			med_octave = med_octave +1;
			max_octave = max_octave +1;				
		} else if(direction=='down' && min_octave > 1) {
			min_octave = min_octave -1;
			med_octave = med_octave -1;
			max_octave = max_octave -1;				
		}
		
		$('#down-octave').text(min_octave);
		$('#up-octave').text(max_octave);
		
	}






















    function clear_incipit() {
        $('#incipit_01').val('');
        current_oct = -1;
        reset_undos();
        update_incipit();
    }

    
    function onpitch(pitch, oct, alteration, midi)
    {
    
    	var octave_1 = ',,,';
    	var octave_2 = ',,';
    	var octave_3 = ',';
    	var octave_4 = "'";
    	var octave_5 = "''";
    	var octave_6 = "'''";
    	var octave_7 = "''''";
    	var octave_8 = "'''''";
    	var octave_9 = "''''''";

    	if(oct=='min'){
    		oct = min_octave;
    	} else if(oct=='med'){
    		oct = med_octave;
    	} else if(oct=='max'){
    		oct = max_octave;
    	}

        pitch_str = '';

        if(oct!=current_oct){
	        if(oct == 1){
	        	pitch_str = octave_1;
	        } else if(oct == 2){
	        	pitch_str = octave_2;
	        } else if(oct == 3){
	        	pitch_str = octave_3;
	        } else if(oct == 4){
	        	pitch_str = octave_4;
	        } else if(oct == 5){
	        	pitch_str = octave_5;
	        } else if(oct == 6){
	        	pitch_str = octave_6;
	        } else if(oct == 7){
	        	pitch_str = octave_7;
	        } else if(oct == 8){
	        	pitch_str = octave_8;
	        } else if(oct == 9){
	        	pitch_str = octave_9;
	        } 
    	}

        current_oct = oct;
        
        switch (alteration) {

             case 1:
             pitch_str += 'x';
             break;
             case -1:
             pitch_str += 'b';
             break;
        
        }

        pitch_str += current_duration;

        if (current_dot == 1) {
            pitch_str += '.';
        }

        if (current_chord == 1){
        	pitch_str += '^';
        }

        if (current_grace == 1){
        	pitch_str += 'g';
        	current_grace = 0;
        	$('#btn-grace').removeClass('border border-primary');
        }

        pitch_str += pitch;
        undos.push( $('#incipit_01').val() );

        $('#incipit_01').val($('#incipit_01').val() + pitch_str );
        
        update_incipit();
        activate_buttons();

    }

    function reset_undos( )
    {
        undos = [];
    }

    function activate_buttons( ) {
        $('#kb_focus').focus();
    }

    function onduration( value )
    {
        current_duration = value;
        update_buttons();
    }

    function ondot(  )
    {
        if (current_dot == 0) {    
        	current_dot = 1; 
        	$('#btn-dot').addClass('border border-primary');
        } else { 
        	current_dot = 0; 
        	$('#btn-dot').removeClass('border border-primary');
        }
        update_buttons();
    }

    function onrest( )
    {    	
        rest_str = current_duration;
        rest_str += '-';
        undos.push( $('#incipit_01').val() );
        $('#incipit_01').val($('#incipit_01').val() + rest_str );
        update_incipit();
        activate_buttons();
    }

    function onbarline( )
    {
        undos.push( $('#incipit_01').val() );
        $('#incipit_01').val($('#incipit_01').val() + '/' );
        update_incipit();
        activate_buttons();
    }

    function onundo( )
    {
        undo_str = undos.pop();
        $('#incipit_01').val( undo_str );
        update_incipit();
        activate_buttons();

    }

    function update_incipit()
    {

        if ($('#incipit_01').val() == '') {
            current_oct = -1;
            $('#btn_clear_incipit').hide();
        } else {
            $('#btn_clear_incipit').show();
        }

        update_display();
    }

    function update_display()
    {
        pe_incipit('',
                        "clef_01",
                        "key_01",
                        "timesig_01",
                        "incipit_01",
                        "render_01");
    }

    function update_buttons()
    {
        $(".kb").removeClass("ui-state-active");
        $(".kb").addClass("ui-state-default");
        if (current_duration == 9) { $('#kb-00').addClass("ui-state-active"); }
        else if (current_duration == 1) { $('#kb-01').addClass("ui-state-active"); }
        else if (current_duration == 2) { $('#kb-02').addClass("ui-state-active"); }
        else if (current_duration == 4) { $('#kb-04').addClass("ui-state-active"); }
        else if (current_duration == 8) { $('#kb-08').addClass("ui-state-active"); }
        else if (current_duration == 6) { $('#kb-16').addClass("ui-state-active"); }
        else if (current_duration == 3) { $('#kb-32').addClass("ui-state-active"); }
        else if (current_duration == 5) { $('#kb-64').addClass("ui-state-active"); }
        if (current_dot == 1) { $('#kb-dot').addClass("ui-state-active"); }
    }

    $('#incipit_01').keyup(function(event){
        update_incipit();
    });

    $('#clef_01').change(function(event){
        update_incipit();
    });

    $('#key_01').change(function(event){
        update_incipit();
    });

    $('#timesig_01').keyup(function(event){
        update_incipit();
    });

    $('#kb_focus').keypress(function(event) {
        if (event.charCode == 57) { onduration(9); } 
        else if (event.charCode == 49) { onduration(1); } 
        else if (event.charCode == 50) { onduration(2); } 
        else if (event.charCode == 52) { onduration(4); } 
        else if (event.charCode == 56) { onduration(8); } 
        else if (event.charCode == 54) { onduration(6); } 
        else if (event.charCode == 51) { onduration(3); } 
        else if (event.charCode == 53) { onduration(5); } 
        else if ((event.charCode == 82) || (event.charCode == 114) || (event.charCode == 45)) { onrest(); }
        else if ((event.charCode == 68) || (event.charCode == 100) || (event.charCode == 46)) { ondot(); }
        else if ((event.charCode == 66) || (event.charCode == 98) || (event.charCode == 47)) { onbarline(); }
        else if ((event.charCode == 85) || (event.charCode == 117)) { onundo(); }
    });

    if ($('#incipit_01').val() != "") {
        update_incipit();
    }

    update_buttons();
    activate_buttons();

    var vrvToolkit = new verovio.toolkit();


    function render_music( music, format )
    {

        var svg = vrvToolkit.renderData(music + "\n", {
            inputFormat: 'pae', 
            scale: 50, 
            adjustPageHeight: 1, 
            pageWidth: 1048, 
            border: 0, 
            spacingStaff: 2,
            xmlIdSeed: 1
        });
        document.getElementById('render_01').innerHTML = svg;

        var mei = vrvToolkit.getMEI( 1, true );
        
        $("#mei_output").text(mei);

    };

    function pe_incipit(destination_column, clef, keysig, timesig, incipit, target)
    {
        jquery_clef = clef.replace(/(\[|\])/g, '\\$1');
        jquery_keysig = keysig.replace(/(\[|\])/g, '\\$1');
        jquery_timesig = timesig.replace(/(\[|\])/g, '\\$1');
        jquery_incipit = incipit.replace(/(\[|\])/g, '\\$1');

        pae_clef = $('#' + jquery_clef).val();
        pae_keysig =  $('#' + jquery_keysig).val();
        pae_timesig = $('#' + jquery_timesig).val();
        pae_incipit = $('#' + jquery_incipit).val();


        pae = "@start:pae-file\n";
        pae = pae + "@clef:" + pae_clef + "\n";
        pae = pae + "@keysig:" + pae_keysig + "\n";
        pae = pae + "@key:\n";
        pae = pae + "@timesig:" + pae_timesig + "\n";
        pae = pae + "@data: " + pae_incipit + "\n";
        pae = pae + "@end:pae-file\n";
        render_music(pae, 'pae');

    }

    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }

    $( document ).ready(function() {

        var pae = getParameterByName("pae");

        if (pae != "") {
            $("#incipit_01").val(pae);
            update_incipit();
        }
    });


	</script>

</body>	
</html>
